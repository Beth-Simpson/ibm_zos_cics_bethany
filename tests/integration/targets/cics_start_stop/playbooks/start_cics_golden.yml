# (c) Copyright IBM Corp. 2023
# Apache License, Version 2.0 (see https://opensource.org/licenses/Apache-2.0)
---
- name: Test Start CICS Golden Path
  hosts: 'all'
  gather_facts: false
  environment: "{{ environment_vars }}"

  tasks:
    - name: Start CICS Region
      ibm.ibm_zos_cics.start_cics:
        submit_jcl: true
        applid: "{{ start_region_applid }}"
        job_parameters:
          region: 0M
        cics_data_sets:
          template: "{{ cics_install_path }}.<< lib_name >>"
          sdfhlic: "{{ cics_install_path }}.LIC.SDFHLIC"
        le_data_sets:
          template: "{{ le_path }}.<< lib_name >>"
        region_data_sets:
          template: "{{ region_data_set_path }}.<< data_set_name >>"
        sit_parameters:
          start: INITIAL
          sit: 6$
          aicons: AUTO
          cicssvc: 217
          edsalim: 500M
          grplist: (DFHLIST*)
          gmtext: '''Welcome to CICS Design Partnership'''
          srbsvc: 218
          tcpip: "NO"
          usshome: /cics/cics740
          sysidnt: ZPY1
      register: start_result

    - name: Log output of start
      ansible.builtin.debug:
        msg: "{{ start_result  }}"

    - name: Assert Start CICS Module did not fail
      ansible.builtin.assert:
        that:
          - start_result.executions | length == 1
          - start_result.executions[0].rc == 0
          - start_result.failed == False
          - start_result.changed == True
        fail_msg: "Start CICS module failed"

    - name: Check jobs running
      ibm.ibm_zos_core.zos_job_query:
        job_name: "{{ start_region_applid }}"
      register: running_result

    - name: Assert CICS started
      ansible.builtin.assert:
        that:
          - running_result.jobs | selectattr("ret_code", 'equalto', None) | list | length > 0
          - running_result.failed != True
        fail_msg: "CICS Region did not start successfully"
