# (c) Copyright IBM Corp. 2023
# Apache License, Version 2.0 (see https://opensource.org/licenses/Apache-2.0)
---
- name: Stop CICS
  hosts: 'all'
  gather_facts: false
  environment: "{{ environment_vars }}"

  tasks:
    - name: Issue shutdown command
      environment: "{{ environment_vars }}"
      ibm.ibm_zos_cics.stop_cics:
        job_name: "{{ start_region_applid }}"
        mode: "{{ mode }}"
      register: stop_result

    - name: Log output of stop
      ansible.builtin.debug:
        msg: "{{ stop_result }}"

    - name: Assert CICS stop did not fail
      ansible.builtin.assert:
        that:
          - stop_result.failed != True
        fail_msg: "CICS Region did not stop successfully"

    - name: Check jobs running
      ibm.ibm_zos_core.zos_job_query:
        job_name: "{{ start_region_applid }}"
      register: jobs_running_after_stop

    - name: Assert CICS stopped
      ansible.builtin.assert:
        that:
          - jobs_running_after_stop.jobs | selectattr("ret_code", 'equalto', None) | list | length == 0
          - jobs_running_after_stop.failed == false
        fail_msg: "CICS Region did not stop successfully"
